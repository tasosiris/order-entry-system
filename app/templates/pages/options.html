{% extends "layouts/base.html" %}

{% block title %}Order Entry System - Options Trading{% endblock %}

{% block options_active %}active{% endblock %}

{% block additional_head %}
<script type="module">
    import { Autocomplete, SYMBOL_LISTS } from '/static/js/modules/autocomplete.js';
    import { OrderBook } from '/static/js/modules/orderbook.js';

    document.addEventListener('DOMContentLoaded', function() {
        // Initialize autocomplete for option symbols
        const symbolInput = document.getElementById('symbol');
        if (symbolInput) {
            new Autocomplete(symbolInput, {
                symbols: SYMBOL_LISTS.options,
                onSelect: (symbol) => {
                    // Update order books when symbol changes
                    if (window.orderBook) {
                        window.orderBook.setSymbol(symbol);
                    }
                    // Update option analytics
                    fetchOptionAnalytics(symbol);
                }
            });
        }

        // Initialize order books
        window.orderBook = new OrderBook({
            internalSelector: '#internal-book',
            externalSelector: '#external-book',
            internalEndpoint: '/api/orderbook/internal?asset_type=options',
            externalEndpoint: '/api/orderbook/external?asset_type=options'
        });

        // Order type button selection
        const marketBtn = document.getElementById('market-order-btn');
        const limitBtn = document.getElementById('limit-order-btn');
        const priceField = document.getElementById('price-field');
        const orderTypeInput = document.getElementById('order-type-input');

        marketBtn.addEventListener('click', () => {
            marketBtn.classList.add('active');
            limitBtn.classList.remove('active');
            priceField.style.display = 'none';
            orderTypeInput.value = 'market';
        });

        limitBtn.addEventListener('click', () => {
            limitBtn.classList.add('active');
            marketBtn.classList.remove('active');
            priceField.style.display = 'block';
            orderTypeInput.value = 'limit';
        });

        // Set market order by default
        marketBtn.click();

        // Handle buy/sell button clicks
        const orderForm = document.getElementById('order-form');
        const typeInput = document.getElementById('type');
        const buyButton = document.querySelector('.buy-btn');
        const sellButton = document.querySelector('.sell-btn');

        if (buyButton && sellButton && typeInput) {
            buyButton.addEventListener('click', () => {
                typeInput.value = 'buy';
            });

            sellButton.addEventListener('click', () => {
                typeInput.value = 'sell';
            });
        }

        // Tab switching functionality
        const tabs = document.querySelectorAll('.tab-btn');
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const targetTab = tab.getAttribute('data-tab');
                const tabContent = document.querySelector(`[data-tab-content="${targetTab}"]`);
                
                // Remove active class from all tabs and hide all content
                tabs.forEach(t => t.classList.remove('active'));
                document.querySelectorAll('[data-tab-content]').forEach(content => {
                    content.style.display = 'none';
                });
                
                // Activate selected tab and show content
                tab.classList.add('active');
                tabContent.style.display = 'block';
            });
        });

        // Function to update latency display
        function updateLatencyDisplay(latency) {
            const latencyElement = document.getElementById('latency-value');
            latencyElement.textContent = `${latency}ms`;
            
            latencyElement.classList.remove('low-latency', 'medium-latency', 'high-latency');
            if (latency < 10) {
                latencyElement.classList.add('low-latency');
            } else if (latency < 50) {
                latencyElement.classList.add('medium-latency');
            } else {
                latencyElement.classList.add('high-latency');
            }
        }

        // WebSocket connection for real-time updates
        const ws = new WebSocket(`ws://${window.location.host}/ws`);
        ws.onmessage = function(event) {
            const data = JSON.parse(event.data);
            if (data.type === 'latency') {
                updateLatencyDisplay(data.value);
            }
        };

        // Function to fetch and update option analytics
        async function fetchOptionAnalytics(symbol) {
            try {
                const response = await fetch(`/api/options/analytics?symbol=${symbol}`);
                if (response.ok) {
                    const data = await response.json();
                    updateOptionAnalytics(data);
                }
            } catch (e) {
                console.error('Error fetching option analytics:', e);
            }
        }

        function updateOptionAnalytics(data) {
            document.getElementById('delta-value').textContent = data.delta || '--';
            document.getElementById('gamma-value').textContent = data.gamma || '--';
            document.getElementById('theta-value').textContent = data.theta || '--';
            document.getElementById('vega-value').textContent = data.vega || '--';
            document.getElementById('iv-value').textContent = data.iv || '--';
        }

        // Function to fetch orders
        function fetchOrders(type) {
            const tableBody = document.getElementById(`${type}-orders-body`);
            
            fetch(`/api/orders/${type}?asset_type=options`)
                .then(response => response.json())
                .then(data => {
                    if (!data.orders || data.orders.length === 0) {
                        tableBody.innerHTML = `<tr><td colspan="3">No ${type} orders</td></tr>`;
                        return;
                    }
                    
                    let html = '';
                    data.orders.forEach(order => {
                        const orderClass = order.type === 'buy' ? 'buy-order' : 'sell-order';
                        html += `
                        <tr class="order-row ${orderClass}" data-order='${JSON.stringify(order)}'>
                            <td>${order.symbol}</td>
                            <td>$${order.price.toFixed(2)}</td>
                            <td>${order.quantity}</td>
                        </tr>
                        `;
                    });
                    
                    tableBody.innerHTML = html;
                    
                    // Add click listeners to rows
                    document.querySelectorAll('.order-row').forEach(row => {
                        row.addEventListener('click', function() {
                            const orderData = JSON.parse(this.getAttribute('data-order'));
                            showOrderDetails(orderData);
                        });
                    });
                })
                .catch(error => {
                    console.error('Error fetching orders:', error);
                    tableBody.innerHTML = `<tr><td colspan="3">Error loading orders</td></tr>`;
                });
        }

        // Function to show order details
        function showOrderDetails(order) {
            const modal = document.getElementById('order-details-modal');
            const modalContent = document.getElementById('modal-content');
            
            const modalHtml = `
                <h3>Order Details</h3>
                <div class="order-details-grid">
                    <div class="detail-item">
                        <span class="detail-label">Symbol:</span>
                        <span class="detail-value">${order.symbol}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Type:</span>
                        <span class="detail-value">${order.type.toUpperCase()}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Option Type:</span>
                        <span class="detail-value">${order.option_type.toUpperCase()}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Strike:</span>
                        <span class="detail-value">$${order.strike}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Expiration:</span>
                        <span class="detail-value">${order.expiration}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Price:</span>
                        <span class="detail-value">$${order.price}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Quantity:</span>
                        <span class="detail-value">${order.quantity}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Status:</span>
                        <span class="detail-value">${order.status}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Time in Force:</span>
                        <span class="detail-value">${order.tif.toUpperCase()}</span>
                    </div>
                </div>
                ${order.status === 'open' ? `
                    <div class="modal-actions">
                        <button class="cancel-order-btn" onclick="cancelOrder('${order.id}')">Cancel Order</button>
                        <button class="modify-order-btn" onclick="modifyOrder(${JSON.stringify(order)})">Modify Order</button>
                    </div>
                ` : ''}
            `;
            
            modalContent.innerHTML = modalHtml;
            modal.style.display = 'flex';
        }

        // Function to cancel order
        window.cancelOrder = function(orderId) {
            if (confirm('Are you sure you want to cancel this order?')) {
                fetch(`/api/orders/${orderId}`, { method: 'DELETE' })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            document.getElementById('order-details-modal').style.display = 'none';
                            fetchOrders('open');
                            fetchOrders('cancelled');
                        } else {
                            alert('Failed to cancel order');
                        }
                    })
                    .catch(error => {
                        console.error('Error cancelling order:', error);
                        alert('Error cancelling order');
                    });
            }
        };

        // Function to modify order
        window.modifyOrder = function(order) {
            // Populate form with order details
            document.getElementById('symbol').value = order.symbol;
            document.getElementById('option_type').value = order.option_type;
            document.getElementById('strike').value = order.strike;
            document.getElementById('expiration').value = order.expiration;
            document.getElementById('quantity').value = order.quantity;
            document.getElementById('price').value = order.price;
            document.getElementById('tif').value = order.tif;
            
            // Switch to limit order if there's a price
            if (order.price) {
                limitBtn.click();
            }
            
            // Close modal and scroll to form
            document.getElementById('order-details-modal').style.display = 'none';
            document.querySelector('.order-entry').scrollIntoView({ behavior: 'smooth' });
        };

        // Modal close functionality
        const modal = document.getElementById('order-details-modal');
        const closeModal = document.getElementById('close-modal');
        
        closeModal.addEventListener('click', () => {
            modal.style.display = 'none';
        });
        
        window.addEventListener('click', (event) => {
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        });

        // Initial load of orders
        fetchOrders('open');
        fetchOrders('filled');
        fetchOrders('cancelled');
        
        // Refresh orders periodically
        setInterval(() => {
            fetchOrders('open');
            fetchOrders('filled');
            fetchOrders('cancelled');
        }, 2000);
    });
</script>
{% endblock %}

{% block content %}
<div class="trading-container">
    <!-- Order Entry Panel -->
    <section class="panel order-entry">
        <h2>Options Trading</h2>
        
        <form id="order-form" class="order-form" hx-post="/api/orders" hx-trigger="submit" hx-target="#order-status">
            <!-- Symbol Selection -->
            <div>
                <label for="symbol">Symbol</label>
                <div class="autocomplete-container narrow-input">
                    <input 
                        type="text" 
                        id="symbol" 
                        name="symbol" 
                        required 
                        placeholder="Symbol..."
                    >
                </div>
            </div>
            
            <!-- Option Type -->
            <div>
                <label for="option_type">Option Type</label>
                <select id="option_type" name="option_type" class="narrow-input">
                    <option value="call">Call</option>
                    <option value="put">Put</option>
                </select>
            </div>
            
            <!-- Strike Price -->
            <div>
                <label for="strike">Strike Price</label>
                <input type="number" id="strike" name="strike" step="0.01" min="0.01" required placeholder="Strike" class="narrow-input">
            </div>
            
            <!-- Expiration Date -->
            <div>
                <label for="expiration">Expiration</label>
                <input type="date" id="expiration" name="expiration" required class="narrow-input">
            </div>
            
            <!-- Order Type Selection -->
            <div class="order-type-options">
                <label>Order Type</label>
                <div class="order-type-buttons">
                    <button type="button" id="market-order-btn" class="order-type-btn">Market</button>
                    <button type="button" id="limit-order-btn" class="order-type-btn">Limit</button>
                    <input type="hidden" id="order-type-input" name="order_type" value="market">
                </div>
            </div>
            
            <!-- Price (only visible for limit orders) -->
            <div id="price-field">
                <label for="price">Price</label>
                <input type="number" id="price" name="price" step="0.01" min="0.01" placeholder="Price" class="narrow-input">
            </div>
            
            <!-- Quantity -->
            <div>
                <label for="quantity">Quantity</label>
                <input type="number" id="quantity" name="quantity" step="1" min="1" required placeholder="Qty" class="narrow-input">
            </div>
            
            <!-- Time-in-Force Options -->
            <div>
                <label for="tif">Time in Force</label>
                <select id="tif" name="tif" class="narrow-input">
                    <option value="day">Day</option>
                    <option value="gtc">Good Till Cancelled</option>
                    <option value="ioc">Immediate or Cancel</option>
                    <option value="fok">Fill or Kill</option>
                </select>
            </div>
            
            <!-- Dark Pool Routing Option -->
            <div class="routing-option">
                <div class="routing-toggle">
                    <label class="toggle-switch">
                        <input type="checkbox" name="internal" id="internal-routing">
                        <span class="toggle-slider"></span>
                    </label>
                    <span>Route to Dark Pool</span>
                </div>
            </div>
            
            <!-- Buy/Sell Buttons -->
            <div class="actions">
                <button type="submit" class="buy-btn" data-order-type="buy">BUY</button>
                <button type="submit" class="sell-btn" data-order-type="sell">SELL</button>
                <input type="hidden" id="type" name="type" value="buy">
                <input type="hidden" name="asset_type" value="options">
            </div>
        </form>
        
        <div id="order-status" class="status-message"></div>
        
        <div id="latency-stats" class="latency-indicator">
            Avg. Latency: <span id="latency-value">12ms</span>
        </div>
        
        <!-- Options Analytics -->
        <div class="options-analytics panel">
            <h3>Options Analytics</h3>
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-label">Delta</div>
                    <div class="stat-value" id="delta-value">--</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Gamma</div>
                    <div class="stat-value" id="gamma-value">--</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Theta</div>
                    <div class="stat-value" id="theta-value">--</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Vega</div>
                    <div class="stat-value" id="vega-value">--</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Implied Volatility</div>
                    <div class="stat-value" id="iv-value">--</div>
                </div>
            </div>
        </div>
    </section>

    <!-- Order Book Panels -->
    <section class="panel">
        <h2>Order Books</h2>
        
        <div class="tabs">
            <button class="tab-btn active" data-tab="internal">Internal Book</button>
            <button class="tab-btn" data-tab="external">External Book</button>
        </div>
        
        <div data-tab-content="internal" id="internal-book" class="order-book-panel">
            <h3>Internal Order Book</h3>
            <!-- Order book content will be dynamically populated by JavaScript -->
        </div>
        
        <div data-tab-content="external" id="external-book" class="order-book-panel" style="display: none;">
            <h3>External Order Book</h3>
            <!-- Order book content will be dynamically populated by JavaScript -->
        </div>
    </section>

    <!-- Orders Panel -->
    <section class="panel">
        <h2>Orders</h2>
        
        <div class="tabs">
            <button class="tab-btn active" data-tab="open">Open</button>
            <button class="tab-btn" data-tab="filled">Filled</button>
            <button class="tab-btn" data-tab="cancelled">Cancelled</button>
        </div>
        
        <div data-tab-content="open" class="order-table-section">
            <table class="orders-table">
                <thead>
                    <tr>
                        <th>Symbol</th>
                        <th>Price</th>
                        <th>Quantity</th>
                    </tr>
                </thead>
                <tbody id="open-orders-body">
                    <tr><td colspan="3">Loading orders...</td></tr>
                </tbody>
            </table>
        </div>
        
        <div data-tab-content="filled" class="order-table-section" style="display: none;">
            <table class="orders-table">
                <thead>
                    <tr>
                        <th>Symbol</th>
                        <th>Price</th>
                        <th>Quantity</th>
                    </tr>
                </thead>
                <tbody id="filled-orders-body">
                    <tr><td colspan="3">Loading orders...</td></tr>
                </tbody>
            </table>
        </div>
        
        <div data-tab-content="cancelled" class="order-table-section" style="display: none;">
            <table class="orders-table">
                <thead>
                    <tr>
                        <th>Symbol</th>
                        <th>Price</th>
                        <th>Quantity</th>
                    </tr>
                </thead>
                <tbody id="cancelled-orders-body">
                    <tr><td colspan="3">Loading orders...</td></tr>
                </tbody>
            </table>
        </div>
    </section>
</div>

<!-- Order Details Modal -->
<div id="order-details-modal" class="modal">
    <div class="modal-container">
        <div id="modal-content" class="modal-content">
            <!-- Content will be dynamically populated -->
        </div>
        <button id="close-modal" class="close-modal">&times;</button>
    </div>
</div>

<style>
    .trading-container {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
    }
    
    .trading-container .panel {
        flex: 1;
        min-width: 300px;
        margin-bottom: 1rem;
    }
    
    .narrow-input {
        max-width: 150px;
    }
    
    .order-type-buttons {
        display: flex;
        gap: 0.5rem;
        margin-top: 0.5rem;
    }
    
    .order-type-btn {
        flex: 1;
        padding: 0.75rem 1rem;
        background-color: var(--card-dark);
        border: 1px solid var(--border-dark);
        color: var(--text-dark);
        border-radius: 0.5rem;
        cursor: pointer;
        text-align: center;
        transition: all 0.2s;
    }
    
    .order-type-btn.active {
        background-color: var(--primary-color);
        border-color: var(--primary-color);
        color: white;
    }
    
    .latency-indicator {
        font-size: 0.9rem;
        margin-top: 1rem;
        text-align: center;
        padding: 0.5rem;
        background: var(--card-dark);
        border-radius: 0.25rem;
        border: 1px solid var(--border-dark);
    }
    
    #latency-value {
        font-weight: bold;
    }
    
    #latency-value.low-latency {
        color: var(--success-color);
    }
    
    #latency-value.medium-latency {
        color: var(--warning-color);
    }
    
    #latency-value.high-latency {
        color: var(--error-color);
    }
    
    .options-analytics {
        margin-top: 2rem;
    }
    
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 1rem;
        margin-top: 1rem;
    }
    
    .stat-item {
        background: var(--card-dark);
        padding: 1rem;
        border-radius: 0.5rem;
        border: 1px solid var(--border-dark);
        text-align: center;
    }
    
    .stat-label {
        color: var(--text-muted);
        font-size: 0.875rem;
    }
    
    .stat-value {
        font-weight: 600;
    }
    
    .order-row {
        cursor: pointer;
        transition: background-color 0.2s;
    }
    
    .order-row:hover {
        background-color: var(--card-dark);
    }
    
    .order-row.buy-order {
        color: var(--success-color);
    }
    
    .order-row.sell-order {
        color: var(--danger-color);
    }
    
    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.8);
        z-index: 1000;
        justify-content: center;
        align-items: center;
    }
    
    .modal-container {
        position: relative;
        background: var(--card-dark);
        padding: 2rem;
        border: 1px solid var(--border-dark);
        max-width: 600px;
        width: 90%;
    }
    
    .close-modal {
        position: absolute;
        top: 1rem;
        right: 1rem;
        background: none;
        border: none;
        color: var(--text-dark);
        font-size: 1.5rem;
        cursor: pointer;
    }
    
    .order-details-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin: 1rem 0;
    }
    
    .detail-item {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
    }
    
    .detail-value {
        font-weight: 600;
    }
    
    .modal-actions {
        display: flex;
        gap: 1rem;
        margin-top: 1.5rem;
        justify-content: flex-end;
    }
</style>
{% endblock %}