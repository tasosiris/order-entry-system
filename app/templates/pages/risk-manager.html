{% extends "layouts/base.html" %}

{% block title %}Order Entry System - Risk Management{% endblock %}

{% block risk_manager_active %}active{% endblock %}

{% block content %}
<div class="risk-container">
    <div class="grid-container">
        <section class="panel">
            <h2>Risk Exposure</h2>
            <div class="risk-summary">
                <div class="metrics">
                    <div class="metric">
                        <span class="label">Total Exposure</span>
                        <span class="value">$2,345,678</span>
                    </div>
                    <div class="metric">
                        <span class="label">Daily P&L</span>
                        <span class="value positive">+$12,467</span>
                    </div>
                    <div class="metric">
                        <span class="label">Risk Alerts</span>
                        <span class="value alert">5</span>
                    </div>
                </div>
                
                <div class="charts-container">
                    <div class="chart-box">
                        <h3>Exposure by Asset Class</h3>
                        <div class="asset-metrics">
                            <div class="asset-metric">
                                <span class="asset-label">Stocks</span>
                                <span class="asset-value">$2,345,678</span>
                                <span class="asset-percentage">(100%)</span>
                            </div>
                        </div>
                    </div>
                    <div class="chart-box">
                        <h3>P&L by Asset Class</h3>
                        <div class="asset-metrics">
                            <div class="asset-metric positive">
                                <span class="asset-label">Stocks</span>
                                <span class="asset-value">+$12,467</span>
                                <span class="asset-percentage">(100%)</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        
        <section class="panel">
            <h2>Risk Alerts</h2>
            <div class="risk-alerts-container">
                <div class="alert-item critical">
                    <div class="alert-icon">⚠️</div>
                    <div class="alert-content">
                        <h4>Realized P&L Threshold Exceeded</h4>
                        <p>Trader TRID-0023 has exceeded daily loss limit (-$42,500) for strategy ALPHA-01</p>
                        <span class="alert-time">10:23 AM</span>
                    </div>
                </div>
                <div class="alert-item high">
                    <div class="alert-icon">⚠️</div>
                    <div class="alert-content">
                        <h4>Concentration Risk</h4>
                        <p>Tech sector exposure has reached 32.5% of NAV (threshold: 30%)</p>
                        <span class="alert-time">09:47 AM</span>
                    </div>
                </div>
                <div class="alert-item medium">
                    <div class="alert-icon">⚠️</div>
                    <div class="alert-content">
                        <h4>Order Rate Limit</h4>
                        <p>Trader TRID-0019 placed 37 orders in last 60 seconds (limit: 30)</p>
                        <span class="alert-time">09:35 AM</span>
                    </div>
                </div>
                <div class="alert-item medium">
                    <div class="alert-icon">⚠️</div>
                    <div class="alert-content">
                        <h4>Value at Risk Warning</h4>
                        <p>Portfolio VaR (95%) has reached $187,344 (limit: $175,000)</p>
                        <span class="alert-time">09:12 AM</span>
                    </div>
                </div>
                <div class="alert-item low">
                    <div class="alert-icon">⚠️</div>
                    <div class="alert-content">
                        <h4>Liquidity Constraint Near Limit</h4>
                        <p>TSLA order volume at 8.2% of ADV (limit: 10%)</p>
                        <span class="alert-time">08:58 AM</span>
                    </div>
                </div>
            </div>
        </section>
    </div>
    
    <div class="grid-container">
        <section class="panel">
            <h2>Risk Thresholds</h2>
            <div class="thresholds-container">
                <div class="threshold-group">
                    <h3>Core Order & Exposure Limits</h3>
                    <div class="threshold-item">
                        <label for="max-order-notional">Max Order Notional Value:</label>
                        <input type="number" id="max-order-notional" class="threshold-input" data-threshold-type="max-order-notional" value="1000000">
                        <span class="save-indicator"></span>
                    </div>
                    <div class="threshold-item">
                        <label for="max-daily-notional-trader">Max Daily Notional (Per Trader):</label>
                        <input type="number" id="max-daily-notional-trader" class="threshold-input" data-threshold-type="max-daily-notional-trader" value="5000000">
                        <span class="save-indicator"></span>
                    </div>
                    <div class="threshold-item">
                        <label for="max-daily-notional-strategy">Max Daily Notional (Per Strategy):</label>
                        <input type="number" id="max-daily-notional-strategy" class="threshold-input" data-threshold-type="max-daily-notional-strategy" value="7500000">
                        <span class="save-indicator"></span>
                    </div>
                    <div class="threshold-item">
                        <label for="max-position-size">Max Position Size ($):</label>
                        <input type="number" id="max-position-size" class="threshold-input" data-threshold-type="max-position-size" value="2500000">
                        <span class="save-indicator"></span>
                    </div>
                    <div class="threshold-item">
                        <label for="max-portfolio-weight">Max Portfolio Weight (% NAV):</label>
                        <input type="number" id="max-portfolio-weight" class="threshold-input" data-threshold-type="max-portfolio-weight" value="15">
                        <span class="save-indicator"></span>
                    </div>
                    <div class="threshold-item">
                        <label for="max-open-orders">Max Open Orders (Per Trader):</label>
                        <input type="number" id="max-open-orders" class="threshold-input" data-threshold-type="max-open-orders" value="50">
                        <span class="save-indicator"></span>
                    </div>
                    <div class="threshold-item">
                        <label for="max-order-quantity">Max Order Quantity (Shares):</label>
                        <input type="number" id="max-order-quantity" class="threshold-input" data-threshold-type="max-order-quantity" value="100000">
                        <span class="save-indicator"></span>
                    </div>
                    <div class="threshold-item">
                        <label for="order-frequency-limit">Order Frequency Limit (per min):</label>
                        <input type="number" id="order-frequency-limit" class="threshold-input" data-threshold-type="order-frequency-limit" value="30">
                        <span class="save-indicator"></span>
                    </div>
                </div>
                
                <div class="threshold-group">
                    <h3>Live Risk Metrics</h3>
                    <div class="threshold-item">
                        <label for="realized-pnl-threshold">Realized PnL Threshold (Daily):</label>
                        <input type="number" id="realized-pnl-threshold" class="threshold-input" data-threshold-type="realized-pnl-threshold" value="-500000">
                        <span class="save-indicator"></span>
                    </div>
                    <div class="threshold-item">
                        <label for="unrealized-pnl-threshold">Unrealized PnL Threshold:</label>
                        <input type="number" id="unrealized-pnl-threshold" class="threshold-input" data-threshold-type="unrealized-pnl-threshold" value="-750000">
                        <span class="save-indicator"></span>
                    </div>
                    <div class="threshold-item">
                        <label for="var-limit">Value at Risk (VaR) Limit:</label>
                        <input type="number" id="var-limit" class="threshold-input" data-threshold-type="var-limit" value="175000">
                        <span class="save-indicator"></span>
                    </div>
                    <div class="threshold-item">
                        <label for="beta-exposure">Beta Exposure Threshold:</label>
                        <input type="number" id="beta-exposure" class="threshold-input" data-threshold-type="beta-exposure" step="0.1" value="1.5">
                        <span class="save-indicator"></span>
                    </div>
                    <div class="threshold-item">
                        <label for="gross-leverage">Gross Leverage Limit:</label>
                        <input type="number" id="gross-leverage" class="threshold-input" data-threshold-type="gross-leverage" step="0.1" value="3.0">
                        <span class="save-indicator"></span>
                    </div>
                    <div class="threshold-item">
                        <label for="net-leverage">Net Leverage Limit:</label>
                        <input type="number" id="net-leverage" class="threshold-input" data-threshold-type="net-leverage" step="0.1" value="2.0">
                        <span class="save-indicator"></span>
                    </div>
                    <div class="threshold-item">
                        <label for="liquidity-constraint">Liquidity Constraint (% ADV):</label>
                        <input type="number" id="liquidity-constraint" class="threshold-input" data-threshold-type="liquidity-constraint" value="10">
                        <span class="save-indicator"></span>
                    </div>
                    <div class="threshold-item">
                        <label for="slippage-threshold">Slippage Estimate Threshold (bps):</label>
                        <input type="number" id="slippage-threshold" class="threshold-input" data-threshold-type="slippage-threshold" value="25">
                        <span class="save-indicator"></span>
                    </div>
                    <div class="threshold-item">
                        <label for="max-drawdown">Maximum Drawdown Allowed (%):</label>
                        <input type="number" id="max-drawdown" class="threshold-input" data-threshold-type="max-drawdown" value="7.5">
                        <span class="save-indicator"></span>
                    </div>
                </div>
                
                <div class="threshold-group">
                    <h3>Compliance & Restrictions</h3>
                    <div class="threshold-item">
                        <label for="restricted-list">Restricted List Check:</label>
                        <select id="restricted-list" class="threshold-input" data-threshold-type="restricted-list">
                            <option value="enabled">Enabled</option>
                            <option value="disabled">Disabled</option>
                        </select>
                        <span class="save-indicator"></span>
                    </div>
                    <div class="threshold-item">
                        <label for="esg-constraint">ESG Constraint (% Fossil Fuel):</label>
                        <input type="number" id="esg-constraint" class="threshold-input" data-threshold-type="esg-constraint" value="5">
                        <span class="save-indicator"></span>
                    </div>
                    <div class="threshold-item">
                        <label for="sector-cap-tech">Sector Cap - Tech (%):</label>
                        <input type="number" id="sector-cap-tech" class="threshold-input" data-threshold-type="sector-cap-tech" value="30">
                        <span class="save-indicator"></span>
                    </div>
                    <div class="threshold-item">
                        <label for="short-exposure">Short Exposure Limit (% NAV):</label>
                        <input type="number" id="short-exposure" class="threshold-input" data-threshold-type="short-exposure" value="50">
                        <span class="save-indicator"></span>
                    </div>
                    <div class="threshold-item">
                        <label for="daily-turnover">Daily Turnover Limit (% NAV):</label>
                        <input type="number" id="daily-turnover" class="threshold-input" data-threshold-type="daily-turnover" value="75">
                        <span class="save-indicator"></span>
                    </div>
                </div>
                
                <div class="risk-meter-container">
                    <h3>Overall Risk Level</h3>
                    <div class="risk-meter">
                        <div class="risk-level" style="width: 65%;"></div>
                        <div class="risk-zones">
                            <div class="zone green">Low</div>
                            <div class="zone yellow">Medium</div>
                            <div class="zone red">High</div>
                        </div>
                    </div>
                    <div class="risk-actions">
                        <button class="btn btn-danger">Emergency Risk Override</button>
                        <button class="btn btn-secondary">Export Risk Report</button>
                    </div>
                </div>
            </div>
        </section>
    
        <!-- All Orders Section moved here -->
        <section class="panel">
            <h2>All Orders (All Accounts)</h2>
            <div id="internal-book" class="order-book">
                <div class="book-content">
                    <div class="book-side bids">
                        <h3>All Bids (Buy Orders)</h3>
                        <table class="book-table">
                            <thead>
                                <tr>
                                    <th>Account</th>
                                    <th>Symbol</th>
                                    <th>Price</th>
                                    <th>Quantity</th>
                                    <th>Total</th>
                                    <th>Time</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody class="bids-body"></tbody>
                        </table>
                    </div>
                    <div class="book-side asks">
                        <h3>All Asks (Sell Orders)</h3>
                        <table class="book-table">
                            <thead>
                                <tr>
                                    <th>Account</th>
                                    <th>Symbol</th>
                                    <th>Price</th>
                                    <th>Quantity</th>
                                    <th>Total</th>
                                    <th>Time</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody class="asks-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>
    </div>
</div>
{% endblock %}

{% block additional_head %}
<script type="module">
    document.addEventListener('DOMContentLoaded', function() {
        // Risk thresholds controls
        const thresholdInputs = document.querySelectorAll('.threshold-input');
        thresholdInputs.forEach(input => {
            input.addEventListener('change', function() {
                const assetType = this.dataset.assetType;
                const thresholdType = this.dataset.thresholdType;
                
                // In a real app, this would update the threshold via API
                console.log(`Updated ${thresholdType} threshold for ${assetType} to ${this.value}`);
                
                // Show success indicator
                const indicator = this.nextElementSibling;
                indicator.textContent = 'Saved';
                indicator.style.display = 'inline';
                
                setTimeout(() => {
                    indicator.style.display = 'none';
                }, 2000);
            });
        });
        
        // Initialize the charts
        initRiskCharts();
        
        // Load all orders
        loadAllOrders();
        
        // Set up auto-refresh of data
        setInterval(() => {
            loadAllOrders();
            // Still try to load recent trades in the background, even though we don't display them
            // This ensures any backend functionality expecting these calls continues to work
            loadRecentTrades();
        }, 5000); // Refresh every 5 seconds
        
        function initRiskCharts() {
            // In a real app, this would use a real charting library like Chart.js
            // For this mockup, we'll just create some simulated data display
            
            createSimpleBarChart('exposure-chart', [
                { label: 'Stocks', value: 65 }
            ]);
            
            createSimpleBarChart('pnl-chart', [
                { label: 'Stocks', value: 15, color: '#10b981' }
            ]);
        }
        
        function createSimpleBarChart(containerId, data) {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            // Clear any existing content
            container.innerHTML = '';
            
            // Calculate the maximum (absolute) value for scaling
            const maxValue = Math.max(...data.map(item => Math.abs(item.value)));
            
            // Create bars
            const barsContainer = document.createElement('div');
            barsContainer.className = 'chart-bars';
            
            data.forEach(item => {
                const barContainer = document.createElement('div');
                barContainer.className = 'chart-bar-container';
                
                const label = document.createElement('div');
                label.className = 'chart-label';
                label.textContent = item.label;
                
                const barWrapper = document.createElement('div');
                barWrapper.className = 'chart-bar-wrapper';
                
                const bar = document.createElement('div');
                bar.className = 'chart-bar';
                bar.style.height = `${Math.abs(item.value) / maxValue * 100}%`;
                bar.style.backgroundColor = item.color || (item.value >= 0 ? '#3b82f6' : '#ef4444');
                
                // Position the bar at the bottom if positive, at the top if negative
                if (item.value >= 0) {
                    bar.style.alignSelf = 'flex-end';
                } else {
                    bar.style.alignSelf = 'flex-start';
                }
                
                const value = document.createElement('div');
                value.className = 'chart-value';
                value.textContent = item.value;
                
                barWrapper.appendChild(bar);
                barContainer.appendChild(barWrapper);
                barContainer.appendChild(label);
                barContainer.appendChild(value);
                
                barsContainer.appendChild(barContainer);
            });
            
            container.appendChild(barsContainer);
        }
    });
    
    // Function to load all orders for all accounts
    async function loadAllOrders() {
        try {
            // Get all orders including filled ones from accounts/orders/all endpoint
            const response = await fetch('/api/accounts/orders/all');
            
            if (!response.ok) {
                throw new Error('Failed to fetch all orders');
            }
            
            const orders = await response.json();
            
            // Handle different response formats
            let ordersList = orders;
            if (orders.orders) { // Legacy format has { orders: [...] }
                ordersList = orders.orders;
            }
            
            console.log(`Successfully loaded ${ordersList.length} orders from all accounts`);
            populateAllOrdersBook(ordersList);
        } catch (error) {
            console.error('Error loading all orders:', error);
            // Don't show error UI, just keep trying
        }
    }

    // Function to populate the all orders book
    function populateAllOrdersBook(orders) {
        const bidTableBody = document.querySelector('#internal-book .bids .bids-body');
        const askTableBody = document.querySelector('#internal-book .asks .asks-body');
        
        if (!bidTableBody || !askTableBody) return;
        
        // Clear existing orders
        bidTableBody.innerHTML = '';
        askTableBody.innerHTML = '';
        
        if (orders.length === 0) {
            bidTableBody.innerHTML = '<tr><td colspan="7" class="text-center">No buy orders</td></tr>';
            askTableBody.innerHTML = '<tr><td colspan="7" class="text-center">No sell orders</td></tr>';
            return;
        }
        
        // Split orders into bids and asks without filtering by symbol or status
        const bids = orders.filter(order => order.type.toLowerCase() === 'buy');
        const asks = orders.filter(order => order.type.toLowerCase() === 'sell');
        
        console.log(`Found ${bids.length} buy orders and ${asks.length} sell orders`);
        
        // Sort bids by price (descending) and then by timestamp (ascending)
        bids.sort((a, b) => {
            const priceDiff = parseFloat(b.price) - parseFloat(a.price);
            if (priceDiff !== 0) return priceDiff;
            return parseFloat(a.timestamp) - parseFloat(b.timestamp);
        });
        
        // Sort asks by price (ascending) and then by timestamp (ascending)
        asks.sort((a, b) => {
            const priceDiff = parseFloat(a.price) - parseFloat(b.price);
            if (priceDiff !== 0) return priceDiff;
            return parseFloat(a.timestamp) - parseFloat(b.timestamp);
        });
        
        // Populate bids
        if (bids.length === 0) {
            bidTableBody.innerHTML = '<tr><td colspan="7" class="text-center">No buy orders</td></tr>';
        } else {
            bids.forEach(order => {
                const row = document.createElement('tr');
                const total = parseFloat(order.price) * parseFloat(order.quantity);
                
                // Get a short account identifier (first 8 chars)
                const accountId = order.account_id ? (order.account_id.substring(0, 8) + '...') : 'Unknown';
                
                // Add class based on status
                if (order.status === 'filled') {
                    row.classList.add('order-filled');
                } else if (order.status === 'cancelled') {
                    row.classList.add('order-cancelled');
                } else {
                    row.classList.add('order-open');
                }
                
                const statusDisplay = `<span class="order-status ${order.status}">${order.status || 'open'}</span>`;
                
                row.innerHTML = `
                    <td>${accountId}</td>
                    <td>${order.symbol}</td>
                    <td>$${parseFloat(order.price).toFixed(2)}</td>
                    <td>${parseInt(order.quantity)}</td>
                    <td>$${total.toFixed(2)}</td>
                    <td>${new Date(order.timestamp * 1000).toLocaleTimeString()}</td>
                    <td>${statusDisplay}</td>
                `;
                
                bidTableBody.appendChild(row);
            });
        }
        
        // Populate asks
        if (asks.length === 0) {
            askTableBody.innerHTML = '<tr><td colspan="7" class="text-center">No sell orders</td></tr>';
        } else {
            asks.forEach(order => {
                const row = document.createElement('tr');
                const total = parseFloat(order.price) * parseFloat(order.quantity);
                
                // Get a short account identifier (first 8 chars)
                const accountId = order.account_id ? (order.account_id.substring(0, 8) + '...') : 'Unknown';
                
                // Add class based on status
                if (order.status === 'filled') {
                    row.classList.add('order-filled');
                } else if (order.status === 'cancelled') {
                    row.classList.add('order-cancelled');
                } else {
                    row.classList.add('order-open');
                }
                
                const statusDisplay = `<span class="order-status ${order.status}">${order.status || 'open'}</span>`;
                
                row.innerHTML = `
                    <td>${accountId}</td>
                    <td>${order.symbol}</td>
                    <td>$${parseFloat(order.price).toFixed(2)}</td>
                    <td>${parseInt(order.quantity)}</td>
                    <td>$${total.toFixed(2)}</td>
                    <td>${new Date(order.timestamp * 1000).toLocaleTimeString()}</td>
                    <td>${statusDisplay}</td>
                `;
                
                askTableBody.appendChild(row);
            });
        }
    }
    
    // Function to load recent trades - kept for backend compatibility
    // but we're not displaying the trades in the UI
    async function loadRecentTrades() {
        try {
            const response = await fetch('/api/trades/recent');
            if (!response.ok) {
                // Just log the error, don't display anything since we removed the UI
                console.error(`HTTP error! status: ${response.status}`);
                return;
            }
            const trades = await response.json();
            console.log(`Loaded ${trades?.length || 0} recent trades (not displayed in UI)`);
        } catch (error) {
            console.error('Error loading recent trades:', error);
        }
    }
    
    // Function to cancel an order
    window.cancelOrder = function(orderId) {
        if (!orderId) return;
        
        // Disable the cancel button to prevent multiple clicks
        const cancelBtn = document.querySelector(`button[onclick="cancelOrder('${orderId}')"]`);
        if (cancelBtn) {
            cancelBtn.disabled = true;
            cancelBtn.textContent = "Cancelling...";
        }
        
        if (confirm(`Are you sure you want to cancel order ${orderId}?`)) {
            fetch(`/api/orders/${orderId}/cancel`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => {
                if (!response.ok) {
                    // Handle 404 specifically for "not found or already cancelled"
                    if (response.status === 404) {
                        // Remove the row from the table immediately
                        const orderRow = document.getElementById(`order-row-${orderId}`);
                        if (orderRow) {
                            orderRow.remove();
                        }
                        
                        // Force refresh of the orders table
                        const stocksOrdersBody = document.getElementById('stocks-orders-body');
                        if (stocksOrdersBody) {
                            stocksOrdersBody.setAttribute('hx-trigger', 'load');
                            htmx.process(stocksOrdersBody);
                        }
                        
                        // Show info toast instead of error
                        showToast('Order already cancelled or not found', 'info');
                        return Promise.reject(new Error('Order already cancelled or not found'));
                    }
                    
                    return response.json().then(data => {
                        throw new Error(data.detail || 'Failed to cancel order');
                    });
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    // Refresh orders
                    loadAllOrders();
                    
                    // Show success toast
                    showToast('Order cancelled successfully', 'success');
                } else {
                    // Show error toast
                    showToast(`Failed to cancel order: ${data.message || 'Unknown error'}`, 'error');
                    
                    // Re-enable the cancel button if something went wrong
                    if (cancelBtn) {
                        cancelBtn.disabled = false;
                        cancelBtn.textContent = "Cancel";
                    }
                }
            })
            .catch(error => {
                console.error('Error cancelling order:', error);
                
                // Don't show error toast for the case we already handled
                if (error.message !== 'Order already cancelled or not found') {
                    showToast(`Error cancelling order: ${error.message || 'Unknown error'}`, 'error');
                    
                    // Re-enable the cancel button if something went wrong
                    if (cancelBtn) {
                        cancelBtn.disabled = false;
                        cancelBtn.textContent = "Cancel";
                    }
                }
            });
        } else {
            // Re-enable the cancel button if user cancels the confirmation
            if (cancelBtn) {
                cancelBtn.disabled = false;
                cancelBtn.textContent = "Cancel";
            }
        }
    };
    
    // Function to show toast notifications
    function showToast(message, type = 'info') {
        // Create toast element
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.textContent = message;
        
        // Add to document
        document.body.appendChild(toast);
        
        // Show toast
        setTimeout(() => {
            toast.classList.add('show');
        }, 10);
        
        // Hide and remove after delay
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => {
                document.body.removeChild(toast);
            }, 300);
        }, 3000);
    }
</script>
{% endblock %}

{% block additional_styles %}
<style>
    .risk-container {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }
    
    .grid-container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
        margin-bottom: 1rem;
    }
    
    @media (max-width: 1024px) {
        .grid-container {
            grid-template-columns: 1fr;
        }
    }
    
    .panel {
        background-color: var(--bg-secondary, #1a1a1a);
        border-radius: 8px;
        border: 1px solid var(--border-color, #333);
        overflow: hidden;
    }
    
    .panel h2 {
        margin: 0;
        padding: 15px;
        background-color: var(--bg-secondary, #222);
        border-bottom: 1px solid var(--border-color, #333);
        font-size: 1.2rem;
    }
    
    .risk-summary {
        padding: 1rem;
    }
    
    .metrics {
        display: flex;
        justify-content: space-between;
        margin-bottom: 1.5rem;
    }
    
    .metric {
        text-align: center;
        flex: 1;
    }
    
    .label {
        display: block;
        margin-bottom: 0.5rem;
        color: var(--text-muted, #aaa);
    }
    
    .value {
        font-size: 1.5rem;
        font-weight: 600;
    }
    
    .value.positive {
        color: var(--success, #10b981);
    }
    
    .value.negative {
        color: var(--danger, #ef4444);
    }
    
    .value.alert {
        color: var(--danger, #ef4444);
        font-weight: bold;
    }
    
    .charts-container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
    }
    
    .chart-box {
        background-color: var(--bg-tertiary, #222);
        border-radius: 4px;
        padding: 1rem;
    }
    
    .chart-box h3 {
        margin-top: 0;
        margin-bottom: 1rem;
        font-size: 1rem;
        color: var(--text-muted, #aaa);
    }
    
    .chart {
        height: 150px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .thresholds-container {
        padding: 1rem;
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
    }
    
    .threshold-group {
        margin-bottom: 1.5rem;
    }
    
    .threshold-group h3 {
        margin-top: 0;
        margin-bottom: 1rem;
        padding-bottom: 0.5rem;
        border-bottom: 1px solid var(--border-color, #333);
        font-size: 1rem;
    }
    
    .threshold-item {
        display: flex;
        align-items: center;
        margin-bottom: 0.75rem;
    }
    
    .threshold-item label {
        flex: 1;
        padding-right: 1rem;
    }
    
    .threshold-input {
        width: 120px;
        background-color: var(--bg-tertiary, #333);
        border: 1px solid var(--border-color, #444);
        border-radius: 4px;
        padding: 0.5rem;
        color: var(--text-primary, #fff);
    }
    
    .save-indicator {
        width: 50px;
        color: var(--success, #10b981);
        margin-left: 0.5rem;
        display: none;
    }
    
    .risk-alerts-container {
        padding: 1rem;
        max-height: 400px;
        overflow-y: auto;
    }
    
    .alert-item {
        display: flex;
        padding: 0.75rem;
        border-radius: 4px;
        margin-bottom: 0.75rem;
        border-left: 4px solid;
    }
    
    .alert-item.critical {
        background-color: rgba(239, 68, 68, 0.15);
        border-left-color: #ef4444;
    }
    
    .alert-item.high {
        background-color: rgba(245, 158, 11, 0.15);
        border-left-color: #f59e0b;
    }
    
    .alert-item.medium {
        background-color: rgba(249, 115, 22, 0.15);
        border-left-color: #f97316;
    }
    
    .alert-item.low {
        background-color: rgba(59, 130, 246, 0.15);
        border-left-color: #3b82f6;
    }
    
    .alert-icon {
        font-size: 1.5rem;
        margin-right: 0.75rem;
        display: flex;
        align-items: center;
    }
    
    .alert-content {
        flex: 1;
    }
    
    .alert-content h4 {
        margin: 0 0 0.25rem 0;
        font-size: 1rem;
    }
    
    .alert-content p {
        margin: 0;
        font-size: 0.875rem;
        color: var(--text-muted, #aaa);
    }
    
    .alert-time {
        display: block;
        font-size: 0.75rem;
        color: var(--text-muted, #888);
        margin-top: 0.25rem;
    }
    
    .risk-meter-container {
        margin-top: 2rem;
        padding: 1rem;
        background-color: var(--bg-tertiary, #222);
        border-radius: 4px;
    }
    
    .risk-meter {
        height: 2rem;
        background-color: var(--bg-primary, #111);
        border-radius: 1rem;
        overflow: hidden;
        position: relative;
        margin-bottom: 0.75rem;
    }
    
    .risk-level {
        position: absolute;
        top: 0;
        left: 0;
        height: 100%;
        background: linear-gradient(to right, #10b981, #f59e0b, #ef4444);
        border-radius: 1rem;
    }
    
    .risk-zones {
        display: flex;
        justify-content: space-between;
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
    }
    
    .zone {
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #fff;
        font-weight: bold;
        font-size: 0.8rem;
        text-transform: uppercase;
    }
    
    .risk-actions {
        display: flex;
        gap: 1rem;
        margin-top: 1rem;
        justify-content: flex-end;
    }
    
    .btn {
        padding: 0.5rem 1rem;
        border-radius: 4px;
        border: none;
        font-weight: bold;
        cursor: pointer;
    }
    
    .btn-danger {
        background-color: #ef4444;
        color: white;
    }
    
    .btn-secondary {
        background-color: #4b5563;
        color: white;
    }
    
    /* Existing styles for order book and trades */
    .order-book, .trades-container {
        padding: 0.5rem;
        max-height: 400px;
        overflow-y: auto;
    }
    
    .book-content {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }
    
    .book-side {
        flex: 1;
    }
    
    .book-side h3 {
        margin-top: 0;
        margin-bottom: 0.5rem;
        font-size: 1rem;
        color: var(--text-muted, #aaa);
    }
    
    .book-table, .trades-table {
        width: 100%;
        border-collapse: collapse;
    }
    
    .book-table th, .trades-table th {
        padding: 0.5rem;
        text-align: left;
        background-color: var(--bg-secondary, #222);
        border-bottom: 1px solid var(--border-color, #333);
        font-weight: 600;
        font-size: 0.9rem;
    }
    
    .book-table td, .trades-table td {
        padding: 0.5rem;
        border-bottom: 1px solid var(--border-color, #222);
        font-size: 0.9rem;
    }
    
    .bids-body tr {
        color: var(--success-color, #10b981);
    }
    
    .asks-body tr {
        color: var(--danger-color, #ef4444);
    }
    
    .order-filled {
        opacity: 0.5;
    }
    
    .order-cancelled {
        opacity: 0.35;
        text-decoration: line-through;
    }
    
    .order-open {
        font-weight: 500;
    }
    
    .order-status {
        padding: 2px 6px;
        border-radius: 3px;
        font-size: 0.8rem;
        text-transform: capitalize;
    }
    
    .order-status.open {
        background-color: rgba(59, 130, 246, 0.2);
        color: #3b82f6;
    }
    
    .order-status.filled {
        background-color: rgba(16, 185, 129, 0.2);
        color: #10b981;
    }
    
    .order-status.cancelled {
        background-color: rgba(239, 68, 68, 0.2);
        color: #ef4444;
    }
    
    .order-status.rejected {
        background-color: rgba(249, 115, 22, 0.2);
        color: #f97316;
    }

    .asset-metrics {
        padding: 1rem;
    }

    .asset-metric {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 0.5rem;
        padding: 0.5rem;
        background-color: var(--bg-primary, #111);
        border-radius: 4px;
    }

    .asset-metric.positive {
        color: var(--success, #10b981);
    }

    .asset-metric.negative {
        color: var(--danger, #ef4444);
    }

    .asset-label {
        font-weight: 500;
    }

    .asset-value {
        font-size: 1.1rem;
        font-weight: 600;
    }

    .asset-percentage {
        color: var(--text-muted, #aaa);
        font-size: 0.9rem;
    }
</style>
{% endblock %} 