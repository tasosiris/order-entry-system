{% extends "layouts/base.html" %}

{% block title %}Order Entry System - Stocks Trading{% endblock %}

{% block stocks_active %}active{% endblock %}

{% block additional_head %}
<script type="module">
    import { Autocomplete, SYMBOL_LISTS } from '/static/js/modules/autocomplete.js';
    import { OrderBook } from '/static/js/modules/orderbook.js';

    document.addEventListener('DOMContentLoaded', function() {
        // Initialize autocomplete for stock symbols
        const symbolInput = document.getElementById('symbol');
        if (symbolInput) {
            new Autocomplete(symbolInput, {
                symbols: SYMBOL_LISTS.stocks,
                onSelect: (symbol) => {
                    // Update order books when symbol changes
                    if (window.orderBook) {
                        window.orderBook.setSymbol(symbol);
                    }
                }
            });
        }

        // Initialize order books
        window.orderBook = new OrderBook({
            internalSelector: '#internal-book',
            externalSelector: '#external-book',
            internalEndpoint: '/api/orderbook/internal?asset_type=stocks',
            externalEndpoint: '/api/orderbook/external?asset_type=stocks'
        });

        // Order type button selection
        const marketBtn = document.getElementById('market-order-btn');
        const limitBtn = document.getElementById('limit-order-btn');
        const priceField = document.getElementById('price-field');
        const orderTypeInput = document.getElementById('order-type-input');

        marketBtn.addEventListener('click', () => {
            marketBtn.classList.add('active');
            limitBtn.classList.remove('active');
            priceField.style.display = 'none';
            orderTypeInput.value = 'market';
        });

        limitBtn.addEventListener('click', () => {
            limitBtn.classList.add('active');
            marketBtn.classList.remove('active');
            priceField.style.display = 'block';
            orderTypeInput.value = 'limit';
        });

        // Set market order by default
        marketBtn.click();

        // Handle buy/sell button clicks
        const orderForm = document.getElementById('order-form');
        const typeInput = document.getElementById('type');
        const buyButton = document.querySelector('.buy-btn');
        const sellButton = document.querySelector('.sell-btn');

        if (buyButton && sellButton && typeInput) {
            buyButton.addEventListener('click', () => {
                typeInput.value = 'buy';
            });

            sellButton.addEventListener('click', () => {
                typeInput.value = 'sell';
            });
        }
    });
</script>
{% endblock %}

{% block content %}
<div class="trading-container">
    <!-- Order Entry Panel -->
    <section class="panel order-entry">
        <h2>Stocks Trading</h2>
        
        <form id="order-form" class="order-form" hx-post="/api/orders" hx-trigger="submit" hx-target="#order-status">
            <!-- Symbol Selection -->
            <div>
                <label for="symbol">Symbol</label>
                <div class="autocomplete-container narrow-input">
                    <input 
                        type="text" 
                        id="symbol" 
                        name="symbol" 
                        required 
                        placeholder="Symbol..."
                    >
                </div>
            </div>
            
            <!-- Order Type Selection -->
            <div class="order-type-options">
                <label>Order Type</label>
                <div class="order-type-buttons">
                    <button type="button" id="market-order-btn" class="order-type-btn">Market</button>
                    <button type="button" id="limit-order-btn" class="order-type-btn">Limit</button>
                    <input type="hidden" id="order-type-input" name="order_type" value="market">
                </div>
            </div>
            
            <!-- Price (only visible for limit orders) -->
            <div id="price-field">
                <label for="price">Price</label>
                <input type="number" id="price" name="price" step="0.01" min="0.01" placeholder="Price" class="narrow-input">
            </div>
            
            <!-- Quantity -->
            <div>
                <label for="quantity">Quantity</label>
                <input type="number" id="quantity" name="quantity" step="1" min="1" required placeholder="Qty" class="narrow-input">
            </div>
            
            <!-- Time-in-Force Options -->
            <div>
                <label for="tif">Time in Force</label>
                <select id="tif" name="tif" class="narrow-input">
                    <option value="day">Day</option>
                    <option value="gtc">Good Till Cancelled</option>
                    <option value="ioc">Immediate or Cancel</option>
                    <option value="fok">Fill or Kill</option>
                </select>
            </div>
            
            <!-- Dark Pool Routing Option -->
            <div class="routing-option">
                <div class="routing-toggle">
                    <label class="toggle-switch">
                        <input type="checkbox" name="internal" id="internal-routing">
                        <span class="toggle-slider"></span>
                    </label>
                    <span>Route to Dark Pool</span>
                </div>
            </div>
            
            <!-- Buy/Sell Buttons -->
            <div class="actions">
                <button type="submit" class="buy-btn" data-order-type="buy">BUY</button>
                <button type="submit" class="sell-btn" data-order-type="sell">SELL</button>
                <input type="hidden" id="type" name="type" value="buy">
                <input type="hidden" name="asset_type" value="stocks">
            </div>
        </form>
        
        <div id="order-status" class="status-message"></div>
        
        <div id="latency-stats" class="latency-indicator">
            Avg. Latency: <span id="latency-value">12ms</span>
        </div>
    </section>

    <!-- Order Book Panels -->
    <section class="panel">
        <h2>Order Books</h2>
        
        <div class="tabs">
            <button class="tab-btn active" data-tab="internal">Internal Book</button>
            <button class="tab-btn" data-tab="external">External Book</button>
        </div>
        
        <div data-tab-content="internal" id="internal-book" class="order-book-panel">
            <h3>Internal Order Book</h3>
            <!-- Order book content will be dynamically populated by JavaScript -->
        </div>
        
        <div data-tab-content="external" id="external-book" class="order-book-panel" style="display: none;">
            <h3>External Order Book</h3>
            <!-- Order book content will be dynamically populated by JavaScript -->
        </div>
    </section>

    <!-- Orders Panel -->
    <section class="panel">
        <h2>Orders</h2>
        
        <div class="tabs">
            <button class="tab-btn active" data-tab="open">Open</button>
            <button class="tab-btn" data-tab="filled">Filled</button>
            <button class="tab-btn" data-tab="cancelled">Cancelled</button>
        </div>
        
        <div data-tab-content="open" class="order-table-section">
            <table class="orders-table">
                <thead>
                    <tr>
                        <th>Symbol</th>
                        <th>Price</th>
                        <th>Quantity</th>
                    </tr>
                </thead>
                <tbody id="open-orders-body">
                    <tr><td colspan="3">Loading orders...</td></tr>
                </tbody>
            </table>
        </div>
        
        <div data-tab-content="filled" class="order-table-section" style="display: none;">
            <table class="orders-table">
                <thead>
                    <tr>
                        <th>Symbol</th>
                        <th>Price</th>
                        <th>Quantity</th>
                    </tr>
                </thead>
                <tbody id="filled-orders-body">
                    <tr><td colspan="3">Loading orders...</td></tr>
                </tbody>
            </table>
        </div>
        
        <div data-tab-content="cancelled" class="order-table-section" style="display: none;">
            <table class="orders-table">
                <thead>
                    <tr>
                        <th>Symbol</th>
                        <th>Price</th>
                        <th>Quantity</th>
                    </tr>
                </thead>
                <tbody id="cancelled-orders-body">
                    <tr><td colspan="3">Loading orders...</td></tr>
                </tbody>
            </table>
        </div>
    </section>
</div>
{% endblock %}

{% block additional_styles %}
<style>
    .trading-container {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
    }
    
    .trading-container .panel {
        flex: 1;
        min-width: 300px;
        margin-bottom: 1rem;
    }
    
    .narrow-input {
        max-width: 150px;
    }
    
    .order-type-buttons {
        display: flex;
        gap: 0.5rem;
        margin-top: 0.5rem;
    }
    
    .order-type-btn {
        flex: 1;
        padding: 0.75rem 1rem;
        background-color: var(--card-dark);
        border: 1px solid var(--border-dark);
        color: var(--text-dark);
        border-radius: 0.5rem;
        cursor: pointer;
        text-align: center;
        transition: all 0.2s;
    }
    
    .order-type-btn.active {
        background-color: var(--primary-color);
        border-color: var(--primary-color);
        color: white;
    }
    
    .latency-indicator {
        font-size: 0.9rem;
        margin-top: 1rem;
        text-align: center;
        padding: 0.5rem;
        background: var(--card-dark);
        border-radius: 0.25rem;
        border: 1px solid var(--border-dark);
    }
    
    #latency-value {
        font-weight: bold;
    }
    
    .order-row {
        cursor: pointer;
        transition: background-color 0.2s;
    }
    
    .order-row:hover {
        background-color: var(--card-dark);
    }
    
    .order-row.buy-order {
        color: var(--success-color);
    }
    
    .order-row.sell-order {
        color: var(--danger-color);
    }
    
    .order-details-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        align-items: center;
        justify-content: center;
    }
    
    .order-details-content {
        background-color: var(--card-dark);
        border-radius: 0.5rem;
        padding: 1.5rem;
        width: 100%;
        max-width: 500px;
        border: 1px solid var(--border-dark);
    }
    
    .order-details-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
        padding-bottom: 0.5rem;
        border-bottom: 1px solid var(--border-dark);
    }
    
    .order-details-header h3 {
        margin: 0;
    }
    
    .order-details-close {
        background: none;
        border: none;
        color: var(--text-dark);
        font-size: 1.5rem;
        cursor: pointer;
    }
    
    .order-detail-item {
        margin-bottom: 0.5rem;
        display: flex;
    }
    
    .order-detail-label {
        font-weight: 600;
        width: 100px;
    }
</style>

<div id="order-details-modal" class="order-details-modal">
    <div class="order-details-content">
        <div class="order-details-header">
            <h3>Order Details</h3>
            <button class="order-details-close">&times;</button>
        </div>
        <div id="order-details-body">
            <div class="order-detail-item">
                <div class="order-detail-label">ID:</div>
                <div id="detail-order-id"></div>
            </div>
            <div class="order-detail-item">
                <div class="order-detail-label">Symbol:</div>
                <div id="detail-symbol"></div>
            </div>
            <div class="order-detail-item">
                <div class="order-detail-label">Type:</div>
                <div id="detail-type"></div>
            </div>
            <div class="order-detail-item">
                <div class="order-detail-label">Order Type:</div>
                <div id="detail-order-type"></div>
            </div>
            <div class="order-detail-item">
                <div class="order-detail-label">Price:</div>
                <div id="detail-price"></div>
            </div>
            <div class="order-detail-item">
                <div class="order-detail-label">Quantity:</div>
                <div id="detail-quantity"></div>
            </div>
            <div class="order-detail-item">
                <div class="order-detail-label">Time:</div>
                <div id="detail-time"></div>
            </div>
            <div class="order-detail-item">
                <div class="order-detail-label">Status:</div>
                <div id="detail-status"></div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Order details modal functionality
        const modal = document.getElementById('order-details-modal');
        const closeBtn = document.querySelector('.order-details-close');
        
        closeBtn.addEventListener('click', function() {
            modal.style.display = 'none';
        });
        
        // Close modal when clicking outside
        window.addEventListener('click', function(event) {
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        });
        
        // Function to show order details
        window.showOrderDetails = function(orderDetails) {
            document.getElementById('detail-order-id').textContent = orderDetails.id || '-';
            document.getElementById('detail-symbol').textContent = orderDetails.symbol || '-';
            document.getElementById('detail-type').textContent = orderDetails.type || '-';
            document.getElementById('detail-order-type').textContent = orderDetails.order_type || '-';
            document.getElementById('detail-price').textContent = orderDetails.price || '-';
            document.getElementById('detail-quantity').textContent = orderDetails.quantity || '-';
            document.getElementById('detail-time').textContent = orderDetails.time || '-';
            document.getElementById('detail-status').textContent = orderDetails.status || '-';
            
            modal.style.display = 'flex';
        };

        // Function to fetch and process orders
        function fetchOrders(type) {
            const tableBody = document.getElementById(`${type}-orders-body`);
            
            fetch(`/api/orders/${type}?asset_type=stocks`)
                .then(response => response.json())
                .then(data => {
                    if (!data.orders || data.orders.length === 0) {
                        tableBody.innerHTML = `<tr><td colspan="3">No ${type} orders</td></tr>`;
                        return;
                    }
                    
                    let html = '';
                    data.orders.forEach(order => {
                        const orderClass = order.type === 'buy' ? 'buy-order' : 'sell-order';
                        html += `
                        <tr class="order-row ${orderClass}" data-order='${JSON.stringify(order.details)}'>
                            <td>${order.symbol}</td>
                            <td>$${order.price.toFixed(2)}</td>
                            <td>${order.quantity}</td>
                        </tr>
                        `;
                    });
                    
                    tableBody.innerHTML = html;
                    
                    // Add click listeners to the new rows
                    document.querySelectorAll('.order-row').forEach(row => {
                        row.addEventListener('click', function() {
                            const orderDetails = JSON.parse(this.getAttribute('data-order'));
                            showOrderDetails(orderDetails);
                        });
                    });
                })
                .catch(error => {
                    console.error('Error fetching orders:', error);
                    tableBody.innerHTML = `<tr><td colspan="3">Error loading orders</td></tr>`;
                });
        }

        // Initial load of orders
        fetchOrders('open');
        fetchOrders('filled');
        fetchOrders('cancelled');
        
        // Set interval to refresh orders periodically
        setInterval(() => {
            fetchOrders('open');
            fetchOrders('filled');
            fetchOrders('cancelled');
        }, 2000);
    });
</script>
{% endblock %} 